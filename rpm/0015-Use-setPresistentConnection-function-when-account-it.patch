From 1ade9e6ffbd0cadedb2e01b07e220d17ad938807 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Val=C3=A9rio=20Val=C3=A9rio?= <valerio.valerio@jolla.com>
Date: Tue, 17 Feb 2015 10:01:07 +0200
Subject: [PATCH 15/21] Use setPresistentConnection function when account it
 disabled

---
 src/plugins/messageservices/imap/imapservice.cpp | 14 ++------------
 1 file changed, 2 insertions(+), 12 deletions(-)

diff --git a/src/plugins/messageservices/imap/imapservice.cpp b/src/plugins/messageservices/imap/imapservice.cpp
index 1c756c00..5c8312c6 100644
--- a/src/plugins/messageservices/imap/imapservice.cpp
+++ b/src/plugins/messageservices/imap/imapservice.cpp
@@ -1621,17 +1621,7 @@ void ImapService::disable()
 {
     QMailAccountConfiguration accountCfg(_accountId);
     ImapConfiguration imapCfg(accountCfg);
-    QMailAccount account(_accountId);
-    const bool hasPersistentConnection = (account.status() & QMailAccount::HasPersistentConnection);
-    if (hasPersistentConnection) {
-        account.setStatus(QMailAccount::HasPersistentConnection, false);
-        account.setLastSynchronized(QMailTimeStamp::currentDateTime());
-        if (!QMailStore::instance()->updateAccount(&account)) {
-            qWarning() << "Unable to update account" << account.id() << "to HasPersistentConnection" << false;
-        } else {
-            qMailLog(Messaging) <<  "HasPersistentConnection for " << account.id() << "changed to" << false;
-        }
-    }
+    setPersistentConnectionStatus(false);
     _accountWasEnabled = false;
     _accountWasPushEnabled = accountPushEnabled();
     _previousPushFolders = imapCfg.pushFolders();
@@ -1947,7 +1937,7 @@ void ImapService::onOnlineStateChanged(bool isOnline)
     qMailLog(Messaging) << "IDLE Session: Network state changed: " << isOnline;
     if (accountPushEnabled() && isOnline && (!_networkSession || _networkSession->state() != QNetworkSession::Connected)) {
         openIdleSession();
-    } else {
+    } else if (!isOnline) {
         onSessionError(QNetworkSession::InvalidConfigurationError);
         closeIdleSession();
     }
-- 
2.17.1

